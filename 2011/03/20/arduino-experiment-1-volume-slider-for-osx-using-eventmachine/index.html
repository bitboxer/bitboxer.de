<!DOCTYPE html>
<html lang="en">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Bitboxer - Arduino Experiment 1 : Volume Slider for OSX using Eventmachine</title>
    <meta name="viewport" content="width=device-width">

    <link href="/atom.xml" rel="alternate" title="Bitboxer" type="application/atom+xml">

    <script src="https://kit.fontawesome.com/e39a1d799d.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="shortcut icon" href="/favicon.ico">
    <script src="/js/index.js"></script>

    <!-- Fathom - simple website analytics - https://github.com/usefathom/fathom -->
    <script>
      (function(f, a, t, h, o, m) {
        a[h] =
          a[h] ||
          function() {
            (a[h].q = a[h].q || []).push(arguments);
          };
        (o = f.createElement("script")),
          (m = f.getElementsByTagName("script")[0]);
        o.async = 1;
        o.src = t;
        o.id = "fathom-script";
        m.parentNode.insertBefore(o, m);
      })(document, window, "//ping.bitboxer.de/tracker.js", "fathom");
      fathom("set", "siteId", "WMQSI");
      fathom("trackPageview");
    </script>
    <!-- / Fathom -->
  </head>
  <body>
    <div class="container">
      <div class="site">
        <div class="header">
          <h1 class="header--title"><a href="https://bodo.tasche.me">Bitboxer</a></h1>
          <div class="header--menu">
            <a class="extra" href="https://bitboxer.de">blog</a>
            <a class="extra" href="https://bodo.tasche.me/projects">projects</a>
            <a class="extra" href="https://bodo.tasche.me">about me</a>
          </div>
        </div>

        <div class="content">
  <article>
    
    <div class="head-without-image">
      <h1 class="headline">Arduino Experiment 1 : Volume Slider for OSX using Eventmachine</h1>
      <time datetime="2011-03-20T13:43:58.000+0100">20 Mar 2011</time>
    </div>
    

    <div class="post">
      <p>At the moment I am experimenting a lot with <a href="http://www.arduino.cc/">Arduino</a>.
Arduino is an open-source electronics prototyping platform that helps you to
build hardware solutions in a very short time.</p>

<p>Arduino can be used as a stand alone solution and can run software on a little
chip that is onboard of the circuit. You can write a little weather station
with it or create a little device that twitters messages if a certain input is
triggered. There are tons of examples for this online. It’s also possible to
connect it to your pc and use it as an input device for your program.  One
solution to react on input from the Arduino board is
<a href="https://github.com/eventmachine/eventmachine/wiki">Eventmachine</a>, an event
driven I/O framework for ruby.</p>

<p>This is a little program that reads data from the serial port and sets the
volume of my mac:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'serialport'</span>
<span class="nb">require</span> <span class="s1">'rubygems'</span>
<span class="nb">require</span> <span class="s1">'eventmachine'</span>

<span class="k">if</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">size</span> <span class="o">&lt;</span> <span class="mi">1</span>
  <span class="nb">puts</span> <span class="s1">'ruby example.rb /dev/tty.your-usbdevice'</span>
  <span class="nb">exit</span> <span class="mi">1</span>
<span class="k">end</span>

<span class="n">sp</span> <span class="o">=</span> <span class="no">SerialPort</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">ARGV</span><span class="p">.</span><span class="nf">shift</span><span class="p">,</span> <span class="mi">9600</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="no">EventMachine</span><span class="o">::</span><span class="n">run</span> <span class="k">do</span>

  <span class="no">EventMachine</span><span class="o">::</span><span class="n">defer</span> <span class="k">do</span>
    <span class="kp">loop</span> <span class="k">do</span>
      <span class="n">line</span> <span class="o">=</span> <span class="n">sp</span><span class="p">.</span><span class="nf">gets</span>
      <span class="k">if</span> <span class="n">line</span>
        <span class="nb">puts</span> <span class="s2">"New volume : </span><span class="si">#{</span><span class="n">line</span><span class="si">}</span><span class="s2">"</span>
        <span class="sb">`osascript -e "set volume </span><span class="si">#{</span><span class="n">line</span><span class="si">}</span><span class="sb">"`</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="n">sp</span><span class="p">.</span><span class="nf">close</span>
</code></pre></div></div>

<p>Before you run it, you need to install the needed gems with <code class="language-plaintext highlighter-rouge">gem install
eventmachine serialport</code>. After that you can start the script with
<code class="language-plaintext highlighter-rouge">ruby example.rb /dev/tty.your-usbdevice</code>.</p>

<p>But what will it read? At the moment it doesn’t read anything because the
Arduino isn’t transmitting data to it. We need a little program that runs on
the Arduino and computes the input and sends a new volume to the serial port.
That code is a little bit longer because it has to reduce the jitter from the
data. You don’t want the volume to constantly switch between 50% and 52%, am I
right :smile: ?</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// analog pin used to connect the potentiometer</span>
<span class="cp">#define POT_PIN        2
</span>
<span class="c1">// READ_AVG is how many readings to average</span>
<span class="c1">// set it to one less than the actual #</span>
<span class="c1">// e.g.: 10 readings = set to 9</span>
<span class="c1">//</span>
<span class="c1">// the more you average, the more accurate your reading is likely to</span>
<span class="c1">// be -- too many though, and you'll start missing changes if the motor</span>
<span class="c1">// is moving quickly</span>
<span class="cp">#define READ_AVG       9
</span>
<span class="c1">// variable to read the value from the analog pin</span>
<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

<span class="c1">// our current and previous potentiometer readings</span>
<span class="kt">int</span> <span class="n">cur_reading</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">pre_reading</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">steps</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// our current readings array, and our previous average readings array</span>
<span class="kt">int</span> <span class="n">vals</span><span class="p">[</span><span class="n">READ_AVG</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">prev_posts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>           <span class="c1">// set up Serial library at 9600 bps</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">read_pot</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">//read the voltage on the potentiometer:</span>
  <span class="n">cur_reading</span> <span class="o">=</span> <span class="n">analogRead</span><span class="p">(</span><span class="n">POT_PIN</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">post</span> <span class="o">=</span> <span class="n">prev_posts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

  <span class="c1">// we're going to average the last READ_AVG reads</span>
  <span class="c1">// put in a value for our current step</span>
  <span class="n">vals</span><span class="p">[</span><span class="n">steps</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_reading</span><span class="p">;</span>

  <span class="c1">// if we've saved enough values to go ahead and perform an average...</span>
  <span class="k">if</span><span class="p">(</span> <span class="n">steps</span> <span class="o">&gt;=</span> <span class="n">READ_AVG</span> <span class="p">)</span> <span class="p">{</span>
     <span class="c1">// reset our read counter</span>
     <span class="n">steps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

     <span class="c1">// determine the average value read</span>
     <span class="c1">// -- this is mostly to deal with big jitter</span>
     <span class="kt">int</span> <span class="n">tot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="kt">int</span> <span class="n">avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

     <span class="c1">// sum up totals</span>
     <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">READ_AVG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">tot</span> <span class="o">+=</span> <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
     <span class="p">}</span>

     <span class="n">avg</span> <span class="o">=</span> <span class="n">tot</span> <span class="o">/</span> <span class="n">READ_AVG</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

     <span class="c1">// ignore current reading if it was either of our last two readings</span>
     <span class="c1">// avoid bouncing back and forth between two readings (slight voltage</span>
     <span class="c1">// variation in the same range)</span>

     <span class="k">if</span><span class="p">(</span> <span class="n">avg</span> <span class="o">==</span> <span class="n">prev_posts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">avg</span> <span class="o">==</span> <span class="n">prev_posts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
       <span class="k">return</span><span class="p">(</span><span class="n">post</span><span class="p">);</span>
     <span class="p">}</span>

     <span class="c1">// determine the absolute difference between the current average</span>
     <span class="c1">// and the previous average</span>
     <span class="n">diff</span> <span class="o">=</span> <span class="n">avg</span> <span class="o">&gt;</span> <span class="n">prev_posts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="n">avg</span> <span class="o">-</span> <span class="n">prev_posts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">prev_posts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">avg</span><span class="p">;</span>

     <span class="c1">// if there's a difference between the averages</span>
     <span class="k">if</span><span class="p">(</span> <span class="n">diff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
       <span class="c1">// move our last reading back, and put our current reading in</span>
       <span class="c1">// our array to track the last two positions</span>
       <span class="n">prev_posts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_posts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
       <span class="n">prev_posts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg</span><span class="p">;</span>
       <span class="n">post</span> <span class="o">=</span> <span class="n">avg</span><span class="p">;</span>
     <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// increment our saved value # for the next loop</span>
    <span class="n">steps</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">(</span><span class="n">post</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// reads the value of the potentiometer and scale it to use it for volumes (between 0 and 7)</span>
  <span class="kt">int</span> <span class="n">newVal</span> <span class="o">=</span> <span class="n">map</span><span class="p">(</span><span class="n">read_pot</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1023</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">newVal</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">newVal</span><span class="p">;</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>Now you have to compile and upload the code ( For details on how to do this,
there is a good <a href="http://arduino.cc/en/Guide/HomePage">documentation</a> about it
).</p>

<p>Connect a potentiometer to +5, GND and Pin 2 and after that it should look
something like this:</p>

<p>More links around Arduino can be found in my <a href="https://pinboard.in/u:bitboxer/t:arduino">pinboard account</a>.</p>

    </div>
  </article>
</div>
<div class="author">
  <div class="author--photo">
    <img class="author--portrait" src="/assets/images/bodo.jpg" alt="Portrait photo of Bodo Tasche">
    <div class="author--name">
      Bodo Tasche
    </div>
    <div class="author--role">
      Polyglot Developer
    </div>
  </div>

  <div class="author--description">
    <p>
      I am a freelance polyglot developer and love HTML5, testing, JavaScript, Ruby and Elixir. In the last 20 years I
      have been in lots of different roles, from Java to Elixir, from backend developer at a 3 people team in an early
      phase startup to the CTO of a web agency. Some of my work can be seen on my <a href="https://bodo.tasche.me/projects">projects page</a>.
    </p>
    <p>
      Need help developing your MVP or to add new features into your current app? Need a CTO or a front/backend
      developer for hire? Send me an <a href="bodo@tasche.me">email</a>.
    </p>
  </div>
</div>
<footer>
  <a href="https://github.com/bitboxer" aria-label="GitHub Profile">
    <i class="fab fa-github"></i>
  </a>
  <a href="https://twitter.com/bitboxer" aria-label="Twitter Profile">
    <i class="fab fa-twitter"></i>
  </a>
  <a href="https://speakerdeck.com/bitboxer" aria-label="Speaker Deck Profile">
    <i class="fab fa-speaker-deck" aria-hidden="true"></i>
  </a>
  <a href="https://www.linkedin.com/in/bodo-tasche-644413b8/" aria-label="Linkedin Profile">
    <i class="fab fa-linkedin"></i>
  </a>
</footer>
      </div>
    </div>
  </body>
</html>
