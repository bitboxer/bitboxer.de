<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Bitboxer - Rails on Uberspace</title>
        <meta name="viewport" content="width=device-width">

        <link href="/atom.xml" rel="alternate" title="Bitboxer" type="application/atom+xml">

        <!-- Normalize the css -->
        <link rel="stylesheet" href="/css/normalize.css">
        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

        <!-- No jquery, no fun :) -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
        <!-- Adjust font size -->
        <script src="/script/flowtype.js"></script>

        <script src="/script/main.js"></script>

        <link href='http://fonts.googleapis.com/css?family=Rosario:400,700,400italic' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:800' rel='stylesheet' type='text/css'>

        
        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-954244-1']);
          _gaq.push(['_trackPageview']);

          (function() {
           var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
           ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
           var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
           })();
        </script>
        
    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <div class="gravatar"><a href="http://bodotasche.de"><img src="/css/gravatar.png" alt="bodos gravatar"></a></div>
              <h1 class="title"><a href="http://bodotasche.de">Bitboxer</a></h1>
              <div class="menu">
                <a class="extra" href="http://bitboxer.de">hacking</a>
                <a class="extra" href="http://blog.wannawork.de">private life</a>
              </div>
            </div>

            <div class="content">
  <h2 class='headline'>Rails on Uberspace</h2>
  <p class="meta">24 Jun 2012</p>

  <div class="post">
  <p>Last week I migrated a few projects to
<a href="http://bitboxer.de/2012/06/17/moved-to-uberspace/">Uberspace</a>. Some of them
are rails projects and I had to find a good way to run them on Uberspace. There
is an entry in the <a href="http://uberspace.de/dokuwiki/cool:rails">Uberspace Wiki</a>
for using Rails, but that one is using FastCGI and no RVM, so I had to find a
way to install passenger on my own. This is how I did it.</p>

<!-- more -->

<p><strong>Installing passenger</strong></p>

<p>First I installed <a href="https://rvm.io/rvm/install/">RVM</a> and configured it. After
that I had to install passenger:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">gem install passenger
passenger-install-nginx-module
</code></pre></div>
<p>This will install passenger and builds a nginx with the passenger module
included. When asked for a location for nginx, answer that with <code>~/nginx</code>.</p>

<p>Now nginx and passenger are installed. Next stop is configuring nginx to run on
the uberspace. Open the <code>~/nginx/conf/nginx.conf</code> and add this at the top:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">daemon off;
</code></pre></div>
<p>This disables the daemon mode. We will run nginx with
<a href="http://uberspace.de/dokuwiki/system:daemontools">Daemontools</a> and don&#39;t need
the ngnix deamon system.</p>

<p>And now in the server block you have to change a few things to make it look
like this:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">listen       MYPORT;

location / {
    root   /home/MYUBERSPACE/MYRAILSPROJECT/current/public;
    passenger_enabled on;
}
</code></pre></div>
<p>Replace MYPORT with an unused port on that machine. Since you are sharing the
ports with all users on the uberspace machine, you have to check for a port
that is not already in use by another user. The root location must be the
public folder inside of the rails project.</p>

<p><strong>Configure memcache</strong></p>

<p>Next stop is memcache. Since the machine is used by a lot of other users, you
should try to remove load from the cpu. Using caching will fix this. Because
you are also sharing the ports, you can&#39;t just start a memcache on an unused
port. If you would do this and cache user data in the memcache, everyone would
have access to those. You don&#39;t want that to happen. The solution to this is
running memcache in unix sockets mode. The unix socket should be in your home
directory, that way only you can access the memcache. Sadly the 2.0 branch of
dalli (the memcache gem) does not support unix sockets
<a href="http://github.com/mperham/dalli/issues/229">anymore</a>, you have to use an old
version of it.</p>

<p>Change the memcache gem line in your <code>Gemfile</code> to this:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">gem &#39;dalli&#39;, &#39;~&gt; 1.1.5&#39;
</code></pre></div>
<p>And now configure your <code>cache_store</code> in <code>config/environments/production.rb</code> to
use the unix socket of your memcache.</p>
<div class="highlight"><pre><code class="ruby language-ruby" data-lang="ruby"><span class="n">config</span><span class="o">.</span><span class="n">cache_store</span> <span class="o">=</span> <span class="ss">:dalli_store</span><span class="p">,</span> <span class="s1">&#39;/home/MYUBERSPACE/memcached.sock&#39;</span>
</code></pre></div>
<p><strong>Starting the services</strong></p>

<p>Now everything should be configured correctly. It is time to start the nginx
and memcache. To do this we will use
<a href="http://uberspace.de/dokuwiki/system:daemontools">daemontools</a>. The daemontools
will start the processes and monitors them. If the uberspace needs to reboot,
it will also restart them.</p>

<p>First install the daemontools with this command:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">uberspace-setup-svscan
</code></pre></div>
<p>Now you can add nginx to the daemontools like this:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">uberspace-setup-service nginx ~/bin/nginx
</code></pre></div>
<p>And memcache like this:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">uberspace-setup-service memcache /usr/bin/memcached -s $HOME/memcached.sock
</code></pre></div>
<p>With that daemontools installs and starts the services. Please look into the
<a href="http://uberspace.de/dokuwiki/system:daemontools">wiki</a> for details.</p>

<p><strong>Redirect the apache requests</strong></p>

<p>Add this to the <code>.htaccess</code> file in <code>$HOME/html</code></p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">RewriteEngine on
RewriteRule ^(.*)$ http://localhost:MYPORT/$1 [P]
</code></pre></div>
<p>This will tell apache to proxy all requests on that domain to the nginx that is
accepting connections on MYPORT.</p>

<p>But always remember: you are sharing that host with other people. Don&#39;t
configure passenger with 40 workers...memory on that machine is a scarce
resource</p>

  </div>

  <div class="disqus">
    <div id="disqus_thread">
      <a></a><p></p>
    </div>
    <script type="text/javascript">
    var disqus_shortname = 'bitboxercodingblog'; 

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>

</div>


          </div>
        </div>

    </body>
</html>
