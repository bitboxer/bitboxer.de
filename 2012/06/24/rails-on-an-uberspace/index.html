<!DOCTYPE html>
<html lang="en">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Bitboxer - Rails on Uberspace</title>
    <meta name="viewport" content="width=device-width">

    <link href="/atom.xml" rel="alternate" title="Bitboxer" type="application/atom+xml">

    <script src="https://kit.fontawesome.com/e39a1d799d.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="shortcut icon" href="/favicon.ico">
    <script src="/js/index.js"></script>

    <!-- Fathom - simple website analytics - https://github.com/usefathom/fathom -->
    <script>
      (function(f, a, t, h, o, m) {
        a[h] =
          a[h] ||
          function() {
            (a[h].q = a[h].q || []).push(arguments);
          };
        (o = f.createElement("script")),
          (m = f.getElementsByTagName("script")[0]);
        o.async = 1;
        o.src = t;
        o.id = "fathom-script";
        m.parentNode.insertBefore(o, m);
      })(document, window, "//ping.bitboxer.de/tracker.js", "fathom");
      fathom("set", "siteId", "WMQSI");
      fathom("trackPageview");
    </script>
    <!-- / Fathom -->
  </head>
  <body>
    <div class="container">
      <div class="site">
        <div class="header">
          <h1 class="header--title"><a href="https://bodo.tasche.me">Bitboxer</a></h1>
          <div class="header--menu">
            <a class="extra" href="https://bitboxer.de">blog</a>
            <a class="extra" href="https://bodo.tasche.me/projects">projects</a>
            <a class="extra" href="https://bodo.tasche.me">about me</a>
          </div>
        </div>

        <div class="content">
  <article>
    
    <div class="head-without-image">
      <h1 class="headline">Rails on Uberspace</h1>
      <time datetime="2012-06-24T18:51:29.000+0200">24 Jun 2012</time>
    </div>
    

    <div class="post">
      <p>Last week I migrated a few projects to
<a href="http://bitboxer.de/2012/06/17/moved-to-uberspace/">Uberspace</a>. Some of them
are rails projects and I had to find a good way to run them on Uberspace. There
is an entry in the <a href="http://uberspace.de/dokuwiki/cool:rails">Uberspace Wiki</a>
for using Rails, but that one is using FastCGI, so I had to find a
way to install passenger on my own. This is how I did it.</p>

<p><strong>Installing passenger</strong></p>

<p>First you have to change the ruby version and add the <code class="language-plaintext highlighter-rouge">--user-install</code> flag to your
rubygems settings. For details on this please see the <a href="https://uberspace.de/dokuwiki/development:ruby">Uberspace Wiki</a>.
And don’t forget to read the bundler paragraph as well :wink: .</p>

<p>After that I had to install passenger:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gem install passenger
passenger-install-nginx-module
</code></pre></div></div>

<p>This will install passenger and builds a nginx with the passenger module
included. When asked for a location for nginx, answer that with <code class="language-plaintext highlighter-rouge">/home/USERNAME/nginx</code>.</p>

<p>Now nginx and passenger are installed. Next stop is configuring nginx to run on
the uberspace. Open the <code class="language-plaintext highlighter-rouge">~/nginx/conf/nginx.conf</code> and add this at the top:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daemon off;
</code></pre></div></div>

<p>This disables the daemon mode. We will run nginx with
<a href="http://uberspace.de/dokuwiki/system:daemontools">Daemontools</a> and don’t need
the ngnix deamon system.</p>

<p>And now in the server block you have to change a few things to make it look
like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>listen       MYPORT;

location / {
    root   /home/MYUBERSPACE/MYRAILSPROJECT/current/public;
    passenger_enabled on;
}
</code></pre></div></div>

<p>Replace MYPORT with an unused port on that machine. Since you are sharing the
ports with all users on the uberspace machine, you have to check for a port
that is not already in use by another user. The root location must be the
public folder inside of the rails project.</p>

<p><strong>Configure memcache</strong></p>

<p>Next stop is memcache. Since the machine is used by a lot of other users, you
should try to remove load from the cpu. Using caching will fix this. Because
you are also sharing the ports, you can’t just start a memcache on an unused
port. If you would do this and cache user data in the memcache, everyone would
have access to those. You don’t want that to happen. The solution to this is
running memcache in unix sockets mode. The unix socket should be in your home
directory, that way only you can access the memcache. Sadly the 2.0 branch of
dalli (the memcache gem) does not support unix sockets
<a href="http://github.com/mperham/dalli/issues/229">anymore</a>, you have to use an old
version of it.</p>

<p>Change the memcache gem line in your <code class="language-plaintext highlighter-rouge">Gemfile</code> to this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gem 'dalli', '~&gt; 1.1.5'
</code></pre></div></div>

<p>And now configure your <code class="language-plaintext highlighter-rouge">cache_store</code> in <code class="language-plaintext highlighter-rouge">config/environments/production.rb</code> to
use the unix socket of your memcache.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">cache_store</span> <span class="o">=</span> <span class="ss">:dalli_store</span><span class="p">,</span> <span class="s1">'/home/MYUBERSPACE/memcached.sock'</span>
</code></pre></div></div>

<p><strong>Starting the services</strong></p>

<p>Now everything should be configured correctly. It is time to start the nginx
and memcache. To do this we will use
<a href="http://uberspace.de/dokuwiki/system:daemontools">daemontools</a>. The daemontools
will start the processes and monitors them. If the uberspace needs to reboot,
it will also restart them.</p>

<p>First install the daemontools with this command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uberspace-setup-svscan
</code></pre></div></div>

<p>Now you can add nginx to the daemontools like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uberspace-setup-service nginx ~/bin/nginx
</code></pre></div></div>

<p>And memcache like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uberspace-setup-service memcache /usr/bin/memcached -s $HOME/memcached.sock
</code></pre></div></div>

<p>With that daemontools installs and starts the services. Please look into the
<a href="http://uberspace.de/dokuwiki/system:daemontools">wiki</a> for details.</p>

<p><strong>Redirect the apache requests</strong></p>

<p>Add this to the <code class="language-plaintext highlighter-rouge">.htaccess</code> file in <code class="language-plaintext highlighter-rouge">$HOME/html</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RewriteEngine on
RewriteRule ^(.*)$ http://localhost:MYPORT/$1 [P]
</code></pre></div></div>

<p>This will tell apache to proxy all requests on that domain to the nginx that is
accepting connections on MYPORT.</p>

<p>But always remember: you are sharing that host with other people. Don’t
configure passenger with 40 workers…memory on that machine is a scarce
resource</p>

    </div>
  </article>
</div>
<div class="author">
  <div class="author--photo">
    <img class="author--portrait" src="/assets/images/bodo.jpg" alt="Portrait photo of Bodo Tasche">
    <div class="author--name">
      Bodo Tasche
    </div>
    <div class="author--role">
      Polyglot Developer
    </div>
  </div>

  <div class="author--description">
    <p>
      I am a freelance polyglot developer and love HTML5, testing, JavaScript, Ruby and Elixir. In the last 20 years I
      have been in lots of different roles, from Java to Elixir, from backend developer at a 3 people team in an early
      phase startup to the CTO of a web agency. Some of my work can be seen on my <a href="https://bodo.tasche.me/projects">projects page</a>.
    </p>
    <p>
      Need help developing your MVP or to add new features into your current app? Need a CTO or a front/backend
      developer for hire? Send me an <a href="bodo@tasche.me">email</a>.
    </p>
  </div>
</div>
<footer>
  <a href="https://github.com/bitboxer" aria-label="GitHub Profile">
    <i class="fab fa-github"></i>
  </a>
  <a href="https://twitter.com/bitboxer" aria-label="Twitter Profile">
    <i class="fab fa-twitter"></i>
  </a>
  <a href="https://speakerdeck.com/bitboxer" aria-label="Speaker Deck Profile">
    <i class="fab fa-speaker-deck" aria-hidden="true"></i>
  </a>
  <a href="https://www.linkedin.com/in/bodo-tasche-644413b8/" aria-label="Linkedin Profile">
    <i class="fab fa-linkedin"></i>
  </a>
</footer>
      </div>
    </div>
  </body>
</html>
